stages:
  - build
  - deploy

variables:
  CONTAINER_STAGING_TAG: $CI_REGISTRY_IMAGE:CI_COMMIT_REF_SLUG-$CI_COMMIT_SHA

build:
  stage: build
  image: docker:dind
  script:
    - /usr/local/bin/dockerd &
    - docker -H unix:///var/run/docker.sock login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker -H unix:///var/run/docker.sock build --tag $CONTAINER_STAGING_TAG .
    - docker -H unix:///var/run/docker.sock push $CONTAINER_STAGING_TAG
  tags:
    - docker

deploy:
  stage: deploy
  variables:
    JOB_NAME: "onlineballpointgame-dev"
    ENDPOINT_URL: "ballpointgame.apps.openforce.com"
    GA_TRACKING_ID: "UA-178259325-2"
  script:
    # Check job's ref name
    - echo $CI_COMMIT_REF_NAME
    # and is this ref protected
    - echo $CI_COMMIT_REF_PROTECTED
    - chmod +x onlineballpointgame.nomad.sh
    - ./onlineballpointgame.nomad.sh > onlineballpointgame.nomad
    - nomad job run onlineballpointgame.nomad
  only:
    - develop
  tags:
    - bastion
    - nomad
    - vault

deploy_prod:
  stage: deploy
  variables:
    JOB_NAME: "onlineballpointgame-prod"
    ENDPOINT_URL: "remoteballpointgame.openforce.com"
    GA_TRACKING_ID: "UA-178259325-1"
  script:
    # Check job's ref name
    - echo $CI_COMMIT_REF_NAME
    # and is this ref protected
    - echo $CI_COMMIT_REF_PROTECTED
    - chmod +x onlineballpointgame.nomad.sh
    - ./onlineballpointgame.nomad.sh > onlineballpointgame.nomad
    - nomad job run onlineballpointgame.nomad
  only:
    - master
  when: manual
  tags:
    - bastion
    - nomad
    - vault
